#!/usr/bin/env node
const requireg=require("requireg"),event=require("codeceptjs").event,path=require("path"),childProcess=require("child_process"),argv=process.argv;let serverInfo="";if(argv.includes("--licenseServer")){const e=argv.indexOf("--licenseServer");e+1<argv.length?(serverInfo=argv[e+1],argv.splice(e,2)):(console.log("[31m%s[0m","Value for require argument cannot be empty."),process.exit())}const fork=childProcess.fork(path.join(__dirname,"check-license.js"),{detached:!0,env:{info:serverInfo},execArgv:[]}),stopLicense="stop";function stopChildProcess(){!0!==fork.killed&&!1!==fork.connected&&fork.send(stopLicense)}process.on("exit",()=>{stopChildProcess()}),fork.on("message",e=>{if(0===e.licenseState)console.log("[32m%s[0m","Connected to License Server successfully."),event.dispatcher.on(event.all.after,(function(){stopChildProcess()})),event.dispatcher.on(event.multiple.after,(function(){stopChildProcess()})),requireg("gondolajs/built/lib/runner");else{switch(e.licenseState){case-2:console.log("[31m%s[0m","Missed require arguments: --licenseServer");break;case 1:case 3:console.log("[31m%s[0m","Cannot connect to License Server. Please verify the machine name and port number.");break;case 2:console.log("[31m%s[0m","Cannot validate your Gondola license. Please contact your License Server administrator or direct to https://docs.gondolatest.com to learn more.");break;case 4:console.log("[31m%s[0m","The max number of users has been reached. Please contact your License Server administrator to purchase more licenses.");break;default:console.log("[31m%s[0m","Failed to connect to License Server.")}process.exit()}});