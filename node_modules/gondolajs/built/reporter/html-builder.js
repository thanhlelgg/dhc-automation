"use strict";var __decorate=this&&this.__decorate||function(e,t,_,s){var i,E=arguments.length,a=E<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,_):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,_,s);else for(var S=e.length-1;S>=0;S--)(i=e[S])&&(a=(E<3?i(a):E>3?i(t,_,a):i(t,_))||a);return E>3&&a&&Object.defineProperty(t,_,a),a},__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var _ in e)Object.hasOwnProperty.call(e,_)&&(t[_]=e[_]);return t.default=e,t};Object.defineProperty(exports,"__esModule",{value:!0});const fs=require("fs"),path=require("path"),lod=__importStar(require("lodash")),exceptionFormatter=require("exception-formatter"),types_1=require("./types"),utils_1=require("./utils"),telemetry_1=require("../telemetry");class HTMLBuilder{constructor(e){this.htmlTemplate="",this.suiteTemplate="",this.specTemplate="",this.specDetailTemplate="",this.specMessageTemplate="",this.specMsgPicTemplate="",this.failTemplate="",this.copiedPic=[],this.config=e;const t=this.config.htmlResultPath?this.config.htmlResultPath:"./report.html";this.picMsgDir=path.resolve(path.dirname(t),"pictures"),this.resultPath=t,utils_1.mkdirp(this.picMsgDir)}buildFrom(e){this.prepareTemplate();const t=new Date(e.endTime.getTime()-e.startTime.getTime()),_={HEL_RUN_TITLE:"",HEL_TEST_STARTTIME:e.startTime,HEL_TEST_ENDTIME:e.endTime,HEL_PRODUCT_NAME:"Gondola reporter",HEL_PRODUCT_VERSION:"0.0.1-BETA",HEL_ENV_ENTRIES:e.env.entry,HEL_PLATFORM:e.env.platform,HEL_NUMBER_OF_TESTS:0,HEL_TEST_DURATION:utils_1.formatTime(t),HEL_NUM_OF_PASSED:0,HEL_NUM_OF_FAILED:0,HEL_NUM_OF_SKIPPED:0,HEL_NUM_OF_DISABLED:0,HEL_NUM_OF_ERROR:0,HEL_TEST_DETAIL:"",HEL_KEYWORDS:[],HEL_STEP_DURATION:utils_1.formatTime(t),HEL_NUM_OF_PASSED_SUITES:0,HEL_NUM_OF_FAILED_SUITES:0,HEL_NUM_OF_PASSED_CHECKPOINTS:0,HEL_NUM_OF_FAILED_CHECKPOINTS:0,HEL_NUM_OF_SKIPPED_CHECKPOINTS:0,HEL_NUM_OF_ERROR_CHECKPOINTS:0,HEL_MAPPED_SUITE_TITLE:this.config.mapSuite?this.config.mapSuite:"TestSuites",HEL_MAPPED_SPEC_TITLE:this.config.mapSpec?this.config.mapSpec:"TestCases"};this.writeItemsResult(e.suites,_),this.resultPath=this.resultPath.replace(".html","_"+e.env.entry+".html"),fs.writeFileSync(this.resultPath,this.interpolate(this.htmlTemplate,_),"utf-8");const s=path.resolve(this.resultPath);e.config.autoOpen&&this.openFile(s)}prepareTemplate(){this.htmlTemplate=fs.readFileSync(this.getTemplate("MasterTemplate.html"),"utf8"),this.suiteTemplate=fs.readFileSync(this.getTemplate("TestSuiteTemplate.html"),"utf8"),this.specTemplate=fs.readFileSync(this.getTemplate("TestCaseTemplate.html"),"utf8"),this.specDetailTemplate=fs.readFileSync(this.getTemplate("TestCaseDetailTemplate.html"),"utf8"),this.specMessageTemplate=fs.readFileSync(this.getTemplate("MessageTemplate.html"),"utf8"),this.specMsgPicTemplate=fs.readFileSync(this.getTemplate("PictureTemplate.html"),"utf8"),this.failTemplate=fs.readFileSync(this.getTemplate("FailTemplate.html"),"utf8")}getTemplate(e){return path.resolve(__dirname,"../../asset/templates",e)}writeItemsResult(e,t){e.forEach(e=>{e.type===types_1.TestTypes.Suite?this.writeSuiteResult(e,t):this.writeSpecResult(e,t)})}writeSuiteResult(e,t){const _={HEL_ID:e.id,HEL_TEST_NAME:e.title,HEL_TEST_DURATION:utils_1.formatTime(new Date(e.endTime-e.startTime)),HEL_TEST_URL:"",HEL_TEST_DETAIL:"",HEL_TEST_STDOUT:"",HEL_NUM_OF_PASSED_SUITES:0,HEL_NUM_OF_FAILED_SUITES:0,HEL_MAPPED_TITLE:this.config.mapSuite?this.config.mapSuite:"Test Suite"};utils_1.isNotEmpty(e.items)&&this.writeItemsResult(e.items,_);const s=0===_.HEL_NUM_OF_FAILED&&0===_.HEL_NUM_OF_FAILED_SUITES?types_1.Status.Passed:types_1.Status.Failed;this.setResultStatus(_,e.status===types_1.Status.Pending?types_1.Status.Pending:s),this.increaseCheckCount(t,_.HEL_NUM_OF_PASSED_CHECKPOINTS||0,_.HEL_NUM_OF_FAILED_CHECKPOINTS||0,_.HEL_NUM_OF_SKIPPED_CHECKPOINTS||0,_.HEL_NUM_OF_ERROR_CHECKPOINTS||0),this.increaseTestCount(t,void 0,_.HEL_NUM_OF_PASSED||0,_.HEL_NUM_OF_FAILED||0,_.HEL_NUM_OF_SKIPPED||0,_.HEL_NUM_OF_DISABLED||0),this.increaseSuiteCount(t,0===_.HEL_NUM_OF_FAILED&&0===_.HEL_NUM_OF_FAILED_SUITES,_),t.HEL_TEST_DETAIL+=this.interpolate(this.suiteTemplate,_)}writeSpecResult(e,t){const _={HEL_ID:e.id,HEL_SPEC_TEXT:e.title,HEL_MAPPED_TITLE:this.config.mapSpec?this.config.mapSpec:"Test Case"};this.buildDetailReport(_,e),this.setResultStatus(_,e.status),this.increaseTestCount(t,e.status),t.HEL_TEST_DETAIL+=this.interpolate(this.specTemplate,_)}buildDetailReport(e,t){const _=utils_1.arraySize(t.failedExpectations),s={HEL_ID:t.id,HEL_TEST_DURATION:utils_1.formatTime(new Date(t.endTime-t.startTime)),HEL_KEYWORDS:t.keywordSteps.map(e=>e.keyword),HEL_STEP_DURATION:t.keywordSteps.map(e=>e.stepDuration),HEL_PASSED_CHECKS_NUMBER:utils_1.arraySize(t.passedExpectations),HEL_TOTAL_CHECKS_NUMBER:utils_1.arraySize(t.passedExpectations)+_,HEL_TEST_MESSAGES:this.writeMsg(t.messages),HEL_TEST_SCREENSHOT_NAME:t.screenshot,HEL_IS_MSG_HIDDEN:0===utils_1.arraySize(t.messages)&&0===_?"hidden":"",HEL_IS_SCRSH_HIDDEN:!this.config.captureScreenOnPassed&&"passed"===t.status||!this.config.captureScreenOnFailed&&"failed"===t.status||"pending"===t.status||"disabled"===t.status?"hidden":""};e.HEL_TEST_DETAIL=this.interpolate(this.specDetailTemplate,s)}writeMsg(e){let t="";return e.forEach(e=>{const _=this.writeAdditionInfo(e);t+=this.interpolate(this.specMessageTemplate,{HEL_TEST_STATUS_CLS:"failed"===e.status?"label-danger":"label-success",HEL_CSS_ICO_STATUS:"failed"===e.status?"glyphicon-remove":"glyphicon-ok",HEL_MSG_CONTENT:e.msg,HEL_ADDITIONAL_INFO:_})}),t}writeAdditionInfo(e){let t="";return e.type===types_1.MsgTypes.Picture&&Object.keys(e.pic).forEach(_=>{const s=this.makeLocalCopy(e.pic[_]);t+=this.interpolate(this.specMsgPicTemplate,{HEL_PIC_PATH:s,HEL_PIC_CAPTION:_})}),utils_1.arraySize(e.failDetail)>0&&e.failDetail.forEach(e=>{t+=this.interpolate(this.failTemplate,{HEL_TEST_FAILED_MSG:e.message,HEL_TEST_FAILED_STACKTRACE:exceptionFormatter(e.stack,{format:"html",inlineStyle:!0})})}),t}makeLocalCopy(e){const t=path.basename(e),_=path.resolve(this.picMsgDir,t);return t in this.copiedPic||(this.copiedPic.push(t),fs.copyFile(e,_,e=>{e&&console.log(e.message)})),path.relative(path.dirname(this.resultPath),_).replace("\\","/")}increaseSuiteCount(e,t,_){e.HEL_NUM_OF_PASSED_SUITES+=_.HEL_NUM_OF_PASSED_SUITES,e.HEL_NUM_OF_FAILED_SUITES+=_.HEL_NUM_OF_FAILED_SUITES,t?e.HEL_NUM_OF_PASSED_SUITES++:e.HEL_NUM_OF_FAILED_SUITES++}setResultStatus(e,t,_){t===types_1.Status.Passed?(e.HEL_TEST_STATUS_CLS="label-success",e.HEL_TEST_STATUS="Passed",e.HEL_CSS_ICO_STATUS="glyphicon-ok"):t===types_1.Status.Failed?(e.HEL_TEST_STATUS_CLS="label-danger",e.HEL_TEST_STATUS="Failed",e.HEL_CSS_ICO_STATUS="glyphicon-remove"):t===types_1.Status.Pending?(e.HEL_TEST_STATUS_CLS="label-warning",e.HEL_TEST_STATUS="Skipped",e.HEL_CSS_ICO_STATUS="glyphicon-ban-circle"):console.log(t),e.HEL_TEST_STATUS_TOOLTIP=_||e.HEL_TEST_STATUS}increaseCheckCount(e,t,_,s,i){e.HEL_NUM_OF_PASSED_CHECKPOINTS?e.HEL_NUM_OF_PASSED_CHECKPOINTS+=t:e.HEL_NUM_OF_PASSED_CHECKPOINTS=t,e.HEL_NUM_OF_FAILED_CHECKPOINTS?e.HEL_NUM_OF_FAILED_CHECKPOINTS+=_:e.HEL_NUM_OF_FAILED_CHECKPOINTS=_,e.HEL_NUM_OF_SKIPPED_CHECKPOINTS?e.HEL_NUM_OF_SKIPPED_CHECKPOINTS+=s:e.HEL_NUM_OF_SKIPPED_CHECKPOINTS=s,e.HEL_NUM_OF_ERROR_CHECKPOINTS?e.HEL_NUM_OF_ERROR_CHECKPOINTS+=i:e.HEL_NUM_OF_ERROR_CHECKPOINTS=i}increaseTestCount(e,t,_,s,i,E){void 0!==_&&void 0!==s&&void 0!==i&&void 0!==E||(t===types_1.Status.Passed?(_=1,s=0,E=0,i=0):t===types_1.Status.Pending?(_=0,s=0,E=0,i=1):(_=0,s=1,E=0,i=0)),void 0===e.HEL_NUMBER_OF_TESTS?e.HEL_NUMBER_OF_TESTS=_+s+i+E:e.HEL_NUMBER_OF_TESTS+=_+s+i+E,void 0===e.HEL_NUM_OF_PASSED?e.HEL_NUM_OF_PASSED=_:e.HEL_NUM_OF_PASSED+=_,void 0===e.HEL_NUM_OF_FAILED?e.HEL_NUM_OF_FAILED=s:e.HEL_NUM_OF_FAILED+=s,void 0===e.HEL_NUM_OF_SKIPPED?e.HEL_NUM_OF_SKIPPED=i:e.HEL_NUM_OF_SKIPPED+=i,void 0===e.HEL_NUM_OF_DISABLED?e.HEL_NUM_OF_DISABLED=E:e.HEL_NUM_OF_DISABLED+=E}interpolate(e,t){return lod.templateSettings.interpolate=/\${([\s\S]+?)}/g,lod.template(e)(t)}openFile(e){const t=new Promise((t,_)=>{require("opener")(e,null,s=>null===s?t(e):_(s))});Promise.all([t])}}__decorate([telemetry_1.captureTelemetry(telemetry_1.EventCategory.HeliumFW,telemetry_1.EventName.GenerateReport)],HTMLBuilder.prototype,"buildFrom",null),exports.HTMLBuilder=HTMLBuilder;
//# sourceMappingURL=../../debug/reporter/html-builder.js.map
