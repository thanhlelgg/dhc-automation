"use strict";var __decorate=this&&this.__decorate||function(e,t,s,r){var i,n=arguments.length,c=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(e,t,s,r);else for(var p=e.length-1;p>=0;p--)(i=e[p])&&(c=(n<3?i(c):n>3?i(t,s,c):i(t,s))||c);return n>3&&c&&Object.defineProperty(t,s,c),c},__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(exports,"__esModule",{value:!0});const html_builder_1=require("./html-builder"),types_1=require("./types"),telemetry_1=require("../telemetry"),path=__importStar(require("path")),os_1=require("os"),configGondola=require("codeceptjs").config;class GondolaReporter{constructor(e){this.config=e,this.suites=[],this.startTime=new Date,this.endTime=new Date,this.internalSuites={},this.internalSpecs={},this.env={entry:String,platform:String},this.fakeFocusedSuite={id:"focused",description:"focused specs",fullName:"focused specs"}}report(e){this.pushMsg({msg:e,type:types_1.MsgTypes.Text})}reportPic(e,t){let s;s="string"==typeof t?{"":t}:t,this.pushMsg({msg:e,type:types_1.MsgTypes.Picture,pic:s})}suiteStarted(e){const t=this.getSuite(e);t.startTime=new Date,t.type=types_1.TestTypes.Suite,t.specs=[],t.suites=[],t.items=[],t.failures=0,t.skipped=0,t.parent=this.currentSuite,this.currentSuite?(this.currentSuite.suites.push(t),this.currentSuite.items.push(t)):this.suites.push(t),this.currentSuite=t}specStarted(e){this.currentSuite||this.suiteStarted(this.fakeFocusedSuite);const t=this.getSpec(e,this.currentSuite);t.startTime=new Date,t.type=types_1.TestTypes.Spec,t.messages=[],t.keywordSteps=[],t.screenshot="",this.currentSpec=t}specDone(e){const t=this.getSpec(e,this.currentSuite);t.endTime=new Date,this.config&&(this.config.captureScreenOnPassed&&"Passed"===types_1.Status[e.status]&&this.currentSpec&&(this.currentSpec.screenshot=this.getScreenshot(t.title)),this.config.captureScreenOnFailed&&"Failed"===types_1.Status[e.status]&&this.currentSpec&&(this.currentSpec.screenshot=this.getScreenshot(t.title))),this.currentSpec&&this.collectFailures(this.currentSpec,this.currentSpec),this.currentSpec=void 0}suiteDone(e){const t=this.getSuite(e);t.parent,t.endTime=new Date,this.currentSuite=t.parent}start(){this.startTime=new Date}done(){this.endTime=new Date;const e=configGondola.get("helpers");void 0!==e.Protractor?(this.env.entry=e.Protractor.browser,this.env.platform=os_1.type()):void 0!==e.Appium&&(this.env.entry=e.Appium.desiredCapabilities.deviceName,this.env.platform=e.Appium.desiredCapabilities.platformName);try{new html_builder_1.HTMLBuilder(this.config?this.config:{}).buildFrom(this)}catch(e){console.error(e.stack)}}startKeywordStep(e,t,s,r,i){this.currentSpec&&this.currentSpec.keywordSteps.push({args:s,id:e,keyword:t,actions:r,stepDuration:i})}endKeywordStep(e,t,s,r,i){if(this.currentSpec&&this.currentSpec.keywordSteps.length>0){this.currentSpec.keywordSteps[this.currentSpec.keywordSteps.length-1].id===e&&this.currentSpec.keywordSteps.pop()}}updateStepDuration(e){this.currentSpec&&this.currentSpec.keywordSteps.length>0&&(this.currentSpec.keywordSteps[this.currentSpec.keywordSteps.length-1].stepDuration=e)}getSuite(e){return this.internalSuites[e.id]||(this.internalSuites[e.id]=Object.assign({},e)),this.internalSuites[e.id]}getSpec(e,t){this.internalSpecs[e.id]?this.updateSpec(this.internalSpecs[e.id],e):this.internalSpecs[e.id]=Object.assign({},e);const s=this.internalSpecs[e.id];return t&&!s.parent&&(s.parent=t,t.specs.push(s),t.items.push(s)),s}updateSpec(e,t){e.status=t.status,e.err=t.err}pushMsg(e){this.currentSpec&&(this.collectFailures(this.currentSpec,this.currentSpec),this.currentSpec.messages.push(e))}collectKeywordStep(e){let t="";for(const s of e.keywordSteps)t=` ${s.keyword}: ${JSON.stringify(s.args)} \r\n`+t;return t}collectFailures(e,t){const s=this.collectKeywordStep(e);if(t.err){let r;0===e.messages.length?(r={msg:"__init__",status:types_1.Status.Unkown,type:types_1.MsgTypes.Text},e.messages.push(r)):r=e.messages[e.messages.length-1],r.failDetail=[t.err,{message:"keyword steps",stack:s}],r.status=types_1.Status.Failed}}getScreenshot(e){let t=configGondola.get("output");const s=configGondola.get("mocha");return void 0!==s&&void 0!==s.reporterOptions&&(t=s.reporterOptions.reportDir),path.resolve(".",t)+"\\"+e.split(" |")[0].replace(/ /g,"_")+".failed.png"}}__decorate([telemetry_1.captureTelemetry(telemetry_1.EventCategory.HeliumFW,telemetry_1.EventName.StartTest)],GondolaReporter.prototype,"start",null),__decorate([telemetry_1.captureTelemetry(telemetry_1.EventCategory.HeliumFW,telemetry_1.EventName.EndTest)],GondolaReporter.prototype,"done",null),exports.GondolaReporter=GondolaReporter;
//# sourceMappingURL=../../debug/reporter/gondola-reporter.js.map
