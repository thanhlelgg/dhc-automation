"use strict";var __importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const childProcess=__importStar(require("child_process")),crypto_1=__importDefault(require("crypto")),path_1=__importDefault(require("path")),{getConfig:getConfig,getTestRoot:getTestRoot,fail:fail}=require("codeceptjs/lib/command/utils"),runHook=require("codeceptjs/lib/hooks"),event=require("codeceptjs/lib/event"),collection=require("codeceptjs/lib/command/run-multiple/collection"),clearString=require("codeceptjs/lib/utils").clearString,replaceValueDeep=require("codeceptjs/lib/utils").replaceValueDeep,runner=path_1.default.join(__dirname,"/../lib/runner");let config;const childOpts={},copyOptions=["override","steps","reporter","verbose","config","reporter-options","grep","fgrep","invert","debug","plugins"];let processesDone,overrides={},runId=1,subprocessCount=0,totalSubprocessCount=0;function executeRun(e,t){let r=Object.assign({},config);const o=t.browser,i=o.browser;for(const e in o)o.hasOwnProperty(e)&&(r.helpers=replaceValueDeep(r.helpers,e,o[e]));let n=`${e}_`;if(o.outputName)"function"==typeof o.outputName?n+=o.outputName():n+=o.outputName;else{const e=crypto_1.default.createHash("md5");e.update(JSON.stringify(o)),n+=e.digest("hex")}n=clearString(n+=`_${runId}`),r=replaceValueDeep(r,"output",path_1.default.join(config.output,n)),r=replaceValueDeep(r,"reportDir",path_1.default.join(config.output,n)),(r=replaceValueDeep(r,"mochaFile",path_1.default.join(config.output,n,`${i}_report.xml`))).tests&&(r.tests=t.tests),r.gherkin&&t.gherkin&&t.gherkin.features&&(r.gherkin.features=t.gherkin.features);const s=["run","--child",`${runId++}.${e}:${i}`,"--override",JSON.stringify(r)];Object.keys(childOpts).forEach(e=>{s.push(`--${e}`),!0!==childOpts[e]&&s.push(childOpts[e])}),t.grep&&(s.push("--grep"),s.push(t.grep));const l=e=>(0!==e&&(process.exitCode=e),(subprocessCount+=1)===totalSubprocessCount&&processesDone(),e);return()=>childProcess.fork(runner,s,{stdio:[0,1,2,"ipc"]}).on("exit",e=>l(e)).on("error",e=>l(1))}module.exports=function(e,t){process.profile=t.profile;const r=t.config,o=getTestRoot(r);global.codecept_dir=o,Object.keys(t).filter(e=>copyOptions.indexOf(e)>-1).forEach(e=>{childOpts[e]=t[e]});try{overrides=JSON.parse(childOpts.override),delete childOpts.override}catch(e){overrides={}}(config={...getConfig(r),...overrides}).multiple||fail('Multiple runs not configured, add "multiple": { /../ } section to config'),(e=t.all?Object.keys(config.multiple):e).length||fail("No runs provided. Use --all option to run all configured runs");runHook(config.bootstrapAll,()=>{event.emit(event.multiple.before,null),t.config&&(config.tests&&(config.tests=path_1.default.resolve(o,config.tests)),config.gherkin&&config.gherkin.features&&(config.gherkin.features=path_1.default.resolve(o,config.gherkin.features))),t.features&&(config.tests=""),t.tests&&config.gherkin&&(config.gherkin.features="");const r=new Promise((e,t)=>{processesDone=e}),i=[];return collection.createRuns(e,config).forEach(e=>{const t=e.getOriginalName()||e.getName(),r=e.getConfig();i.push(executeRun(t,r))}),i.length||fail("Nothing scheduled for execution"),totalSubprocessCount=i.length,i.forEach(e=>e.call(this)),r.then(()=>{runHook(config.teardownAll,()=>event.emit(event.multiple.after,null),"teardownAll")})},"bootstrapAll")};
//# sourceMappingURL=../../debug/command/run-multiple.js.map
